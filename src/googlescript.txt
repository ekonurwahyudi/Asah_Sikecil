function doOptions(e) { 
  var output = ContentService.createTextOutput()
    .setMimeType(ContentService.MimeType.JSON)
    .setContent(JSON.stringify({ status: "success" }));
  
  // Tambahkan header satu per satu
  output.addHeader('Access-Control-Allow-Origin', '*');
  output.addHeader('Access-Control-Allow-Methods', 'POST, GET, OPTIONS');
  output.addHeader('Access-Control-Allow-Headers', 'Content-Type, Origin');
  
  return output;
} 

function doPost(e) { 
  try { 
    // Periksa apakah e dan e.postData ada sebelum mengaksesnya
    if (!e || !e.postData) {
      return ContentService.createTextOutput(JSON.stringify({ 
        status: "error", 
        message: "No post data received" 
      })).setMimeType(ContentService.MimeType.JSON);
    }
    
    // Parse data yang diterima 
    var data = JSON.parse(e.postData.contents); 
    
    // Get the spreadsheet 
    var ss = SpreadsheetApp.getActiveSpreadsheet(); 
    var sheet = ss.getActiveSheet(); 
    var lastRow = sheet.getLastRow(); 
    
    // Log data yang diterima untuk debugging
    Logger.log('Data yang diterima: ' + JSON.stringify(data));
    logToSheet(data);
    
    // Jika ada resultCode, ini adalah callback dari Duitku 
    if (data.resultCode !== undefined) { 
      // Cari baris dengan invoice number yang sesuai 
      var dataRange = sheet.getRange(2, 1, lastRow - 1, sheet.getLastColumn()); 
      var values = dataRange.getValues(); 
      
      // Konversi status code Duitku ke status yang lebih deskriptif
      var paymentStatus = "UNKNOWN";
      if (data.resultCode === "00") {
        paymentStatus = "SUKSES";
      } else if (data.resultCode === "01") {
        paymentStatus = "FAILED";
      } else if (data.resultCode === "02") {
        paymentStatus = "PENDING";
      }
      
      // Log informasi penting dari callback Duitku
      var logData = {
        merchantCode: data.merchantCode,
        merchantOrderId: data.merchantOrderId,
        reference: data.reference,
        resultCode: data.resultCode,
        amount: data.amount,
        paymentStatus: paymentStatus
      };
      logToSheet(logData);
      
      for (var i = 0; i < values.length; i++) { 
        // Kolom 6 adalah invoice (merchantOrderId dari Duitku) 
        if (values[i][6] === data.merchantOrderId) { 
          // Update status di kolom 9 (kolom I) 
          sheet.getRange(i + 2, 9).setValue(paymentStatus); 
          // Update reference di kolom 7 (kolom G) jika ada
          if (data.reference) {
            sheet.getRange(i + 2, 7).setValue(data.reference);
          }
          
          // Log bahwa update berhasil
          logToSheet({
            action: "update_success",
            merchantOrderId: data.merchantOrderId,
            row: i + 2,
            newStatus: paymentStatus
          });
          
          return ContentService.createTextOutput(JSON.stringify({ 
            status: "success", 
            message: "Payment status updated successfully" 
          })).setMimeType(ContentService.MimeType.JSON); 
        } 
      } 
      
      // Jika merchantOrderId tidak ditemukan, coba cari dengan reference
      if (data.reference) {
        for (var i = 0; i < values.length; i++) { 
          // Kolom 7 adalah reference (reference dari Duitku) 
          if (values[i][7] === data.reference) { 
            // Update status di kolom 9 (kolom I) 
            sheet.getRange(i + 2, 9).setValue(paymentStatus); 
            
            // Log bahwa update berhasil dengan reference
            logToSheet({
              action: "update_success_by_reference",
              reference: data.reference,
              row: i + 2,
              newStatus: paymentStatus
            });
            
            return ContentService.createTextOutput(JSON.stringify({ 
              status: "success", 
              message: "Payment status updated successfully by reference" 
            })).setMimeType(ContentService.MimeType.JSON); 
          } 
        }
      }
      
      // Log bahwa invoice tidak ditemukan
      logToSheet({
        action: "invoice_not_found",
        merchantOrderId: data.merchantOrderId,
        reference: data.reference
      });
      
      return ContentService.createTextOutput(JSON.stringify({ 
        status: "error", 
        message: "Invoice not found" 
      })).setMimeType(ContentService.MimeType.JSON); 
    } 
    
    // Jika tidak ada resultCode, ini adalah data baru dari form 
    // Log data form yang diterima
    logToSheet({
      action: "new_form_data",
      formData: data
    });
    
    sheet.appendRow([ 
      new Date(), // Timestamp 
      data.name, 
      data.phone, 
      data.email, 
      data.package, 
      data.invoice,    // Invoice number (merchantOrderId untuk Duitku) 
      data.idinvoice,  // reference untuk Duitku
      data.harga, 
      data.status, 
      data.invoice_url 
    ]);
    
    // Log bahwa data berhasil disimpan
    logToSheet({
      action: "form_data_saved",
      invoice: data.invoice,
      status: data.status
    });
    
    return ContentService.createTextOutput(JSON.stringify({ 
      status: "success", 
      message: "Data saved successfully" 
    })).setMimeType(ContentService.MimeType.JSON);
    
  } catch (error) {
    // Log error
    logToSheet({
      action: "error",
      error: error.toString(),
      data: e.postData ? e.postData.contents : "No data"
    });
    
    return ContentService.createTextOutput(JSON.stringify({ 
      status: "error", 
      message: error.toString() 
    })).setMimeType(ContentService.MimeType.JSON);
  }
}