function doOptions(e) { 
  var output = ContentService.createTextOutput()
    .setMimeType(ContentService.MimeType.JSON)
    .setContent(JSON.stringify({ status: "success" }));
  
  // Tambahkan header satu per satu
  output.addHeader('Access-Control-Allow-Origin', '*');
  output.addHeader('Access-Control-Allow-Methods', 'POST, GET, OPTIONS');
  output.addHeader('Access-Control-Allow-Headers', 'Content-Type, Origin');
  
  return output;
} 

function doPost(e) { 
  try { 
    // Periksa apakah e dan e.postData ada sebelum mengaksesnya
    if (!e || !e.postData) {
      return ContentService.createTextOutput(JSON.stringify({ 
        status: "error", 
        message: "No post data received" 
      })).setMimeType(ContentService.MimeType.JSON);
    }
    
    // Parse data yang diterima 
    var data = JSON.parse(e.postData.contents); 
    
    // Get the spreadsheet 
    var ss = SpreadsheetApp.getActiveSpreadsheet(); 
    var sheet = ss.getActiveSheet(); 
    var lastRow = sheet.getLastRow(); 
    
    // Log data yang diterima untuk debugging
    Logger.log('Data yang diterima: ' + JSON.stringify(data));
    logToSheet(data);
    
    // Jika ada transaction_status, ini adalah callback dari Midtrans 
    if (data.transaction_status !== undefined) { 
      // Cari baris dengan invoice number yang sesuai 
      var dataRange = sheet.getRange(2, 1, lastRow - 1, sheet.getLastColumn()); 
      var values = dataRange.getValues(); 
      
      // Konversi status Midtrans ke status yang lebih deskriptif
      var paymentStatus = "UNKNOWN";
      if (data.transaction_status === "capture" || data.transaction_status === "settlement") {
        paymentStatus = "SUKSES";
      } else if (data.transaction_status === "pending") {
        paymentStatus = "PENDING";
      } else if (data.transaction_status === "deny" || data.transaction_status === "cancel" || 
                 data.transaction_status === "expire" || data.transaction_status === "failure") {
        paymentStatus = "FAILED";
      }
      
      // Log informasi penting dari callback Midtrans
      var logData = {
        order_id: data.order_id,
        transaction_id: data.transaction_id,
        transaction_status: data.transaction_status,
        gross_amount: data.gross_amount,
        payment_type: data.payment_type,
        paymentStatus: paymentStatus
      };
      logToSheet(logData);
      
      for (var i = 0; i < values.length; i++) { 
        // Kolom 6 adalah invoice (order_id dari Midtrans) 
        if (values[i][6] === data.order_id) { 
          // Update status di kolom 9 (kolom I) 
          sheet.getRange(i + 2, 9).setValue(paymentStatus); 
          // Update transaction_id di kolom 7 (kolom G) jika ada
          if (data.transaction_id) {
            sheet.getRange(i + 2, 7).setValue(data.transaction_id);
          }
          
          // Log bahwa update berhasil
          logToSheet({
            action: "update_success",
            order_id: data.order_id,
            row: i + 2,
            newStatus: paymentStatus
          });
          
          return ContentService.createTextOutput(JSON.stringify({ 
            status: "success", 
            message: "Payment status updated successfully" 
          })).setMimeType(ContentService.MimeType.JSON); 
        } 
      } 
      
      // Jika order_id tidak ditemukan, coba cari dengan transaction_id
      if (data.transaction_id) {
        for (var i = 0; i < values.length; i++) { 
          // Kolom 7 adalah transaction_id (transaction_id dari Midtrans) 
          if (values[i][7] === data.transaction_id) { 
            // Update status di kolom 9 (kolom I) 
            sheet.getRange(i + 2, 9).setValue(paymentStatus); 
            
            // Log bahwa update berhasil dengan transaction_id
            logToSheet({
              action: "update_success_by_transaction_id",
              transaction_id: data.transaction_id,
              row: i + 2,
              newStatus: paymentStatus
            });
            
            return ContentService.createTextOutput(JSON.stringify({ 
              status: "success", 
              message: "Payment status updated successfully by transaction_id" 
            })).setMimeType(ContentService.MimeType.JSON); 
          } 
        }
      }
      
      // Log bahwa invoice tidak ditemukan
      logToSheet({
        action: "invoice_not_found",
        order_id: data.order_id,
        transaction_id: data.transaction_id
      });
      
      return ContentService.createTextOutput(JSON.stringify({ 
        status: "error", 
        message: "Invoice not found" 
      })).setMimeType(ContentService.MimeType.JSON); 
    } 
    
    // Jika tidak ada transaction_status, ini adalah data baru dari form 
    // Log data form yang diterima
    logToSheet({
      action: "new_form_data",
      formData: data
    });
    
    sheet.appendRow([ 
      new Date(), // Timestamp 
      data.name, 
      data.phone, 
      data.email, 
      data.package, 
      data.invoice,    // Invoice number (order_id untuk Midtrans) 
      data.idinvoice,  // transaction_id untuk Midtrans
      data.harga, 
      data.status, 
      data.invoice_url 
    ]);
    
    // Log bahwa data berhasil disimpan
    logToSheet({
      action: "form_data_saved",
      invoice: data.invoice,
      status: data.status
    });
    
    return ContentService.createTextOutput(JSON.stringify({ 
      status: "success", 
      message: "Data saved successfully" 
    })).setMimeType(ContentService.MimeType.JSON);
    
  } catch (error) {
    // Log error
    logToSheet({
      action: "error",
      error: error.toString(),
      data: e.postData ? e.postData.contents : "No data"
    });
    
    return ContentService.createTextOutput(JSON.stringify({ 
      status: "error", 
      message: error.toString() 
    })).setMimeType(ContentService.MimeType.JSON);
  }
}

// Fungsi untuk logging ke sheet terpisah
function logToSheet(data) {
  try {
    var ss = SpreadsheetApp.getActiveSpreadsheet();
    var logSheet = ss.getSheetByName('Log') || ss.insertSheet('Log');
    
    logSheet.appendRow([
      new Date(),
      JSON.stringify(data)
    ]);
  } catch (error) {
    Logger.log('Error logging to sheet: ' + error.toString());
  }
}